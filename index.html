<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¬Ø§Ø±Ù‡ ÙÙˆØªØ¨Ø§Ù„</title>

<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fa.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>

<style>
body{font-family:tahoma;background:#f4f6fa;margin:20px}
h2{margin-top:30px}
.card{background:white;padding:20px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,.08);margin-bottom:25px}
button{background:#2962ff;color:white;border:none;padding:8px 15px;border-radius:8px;cursor:pointer}
button:hover{background:#0039cb}
input,select{padding:8px;border-radius:8px;border:1px solid #ccc;width:100%;margin:5px 0}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:center}
.status-green{color:green;font-weight:bold}
.status-red{color:red;font-weight:bold}
.status-zero{color:#555;font-weight:bold}
#clock{font-size:18px;font-weight:bold;margin-bottom:15px}
.reserved{background:#ff5252 !important;color:white !important;border-radius:50%}
</style>
</head>
<body>

<div id="clock"></div>

<div class="card">
<h2>Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ù†Ø³</h2>
<input type="text" id="reservePicker" readonly placeholder="Ø§Ù†ØªØ®Ø§Ø¨ Ú†Ù†Ø¯ ØªØ§Ø±ÛŒØ®">
<p>ØªØ¹Ø¯Ø§Ø¯ Ø¬Ù„Ø³Ø§Øª: <span id="sessionCount">0</span></p>
</div>

<div class="card">
<h2>ØªÙ‚ÙˆÛŒÙ… Ø³Ø§Ù†Ø³â€ŒÙ‡Ø§</h2>
<div id="calendar"></div>
</div>

<div class="card">
<h2>Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø§Ø²ÛŒÚ©Ù†</h2>
<input type="text" id="playerName" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
<button onclick="addPlayer()">Ø§ÙØ²ÙˆØ¯Ù†</button>
</div>

<div class="card">
<h2>Ù„ÛŒØ³Øª Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</h2>
<table class="table">
<thead>
<tr>
<th>Ù†Ø§Ù…</th>
<th>Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</th>
<th>ÙˆØ¶Ø¹ÛŒØª</th>
<th>Ø­Ø°Ù</th>
</tr>
</thead>
<tbody id="playersTable"></tbody>
</table>
</div>

<div class="card">
<h2>Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª</h2>
<select id="payPlayer"></select>
<input type="text" id="payAmount" placeholder="Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ" inputmode="numeric">
<input type="text" id="payDate" readonly placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª">
<button onclick="submitPayment()">Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª</button>
</div>

<script>
let players=JSON.parse(localStorage.getItem("players"))||[]
let reservations=JSON.parse(localStorage.getItem("reservations"))||[]
let payments=JSON.parse(localStorage.getItem("payments"))||[]
let sessionPrice=100000

function saveAll(){
localStorage.setItem("players",JSON.stringify(players))
localStorage.setItem("reservations",JSON.stringify(reservations))
localStorage.setItem("payments",JSON.stringify(payments))
}

function updateClock(){
let now=new Date()
let gy=now.getFullYear(),gm=now.getMonth()+1,gd=now.getDate()
let j=jalaali.toJalaali(gy,gm,gd)
let time=now.toLocaleTimeString()
document.getElementById("clock").innerText=
"ğŸ“… "+j.jy+"/"+j.jm+"/"+j.jd+" â° "+time
}
setInterval(updateClock,1000)

flatpickr.localize(flatpickr.l10ns.fa)

// Ø§Ù†ØªØ®Ø§Ø¨ Ú†Ù†Ø¯ ØªØ§Ø±ÛŒØ®
let reservePicker=flatpickr("#reservePicker",{
mode:"multiple",
dateFormat:"Y-m-d",
onChange:function(selectedDates){
reservations=selectedDates.map(d=>d.toISOString().split('T')[0])
document.getElementById("sessionCount").innerText=reservations.length
saveAll()
calendar.redraw()
}
})

// ØªÙ‚ÙˆÛŒÙ… Ø«Ø§Ø¨Øª Ù†Ù…Ø§ÛŒØ´ Ø³Ø§Ù†Ø³â€ŒÙ‡Ø§
let calendar=flatpickr("#calendar",{
inline:true,
dateFormat:"Y-m-d",
onDayCreate:function(dObj,dStr,fp,dayElem){
let date=dayElem.dateObj.toISOString().split('T')[0]
if(reservations.includes(date)){
dayElem.classList.add("reserved")
}
}
})

// Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª
flatpickr("#payDate",{
dateFormat:"Y-m-d"
})

function addPlayer(){
let name=document.getElementById("playerName").value
if(!name)return
players.push({name})
document.getElementById("playerName").value=""
saveAll()
renderPlayers()
}

function deletePlayer(i){
players.splice(i,1)
saveAll()
renderPlayers()
}

function renderPlayers(){
let totalCost=reservations.length*sessionPrice
let tbody=document.getElementById("playersTable")
tbody.innerHTML=""
document.getElementById("payPlayer").innerHTML=""
players.forEach((p,i)=>{
let paid=payments.filter(x=>x.player===p.name)
.reduce((s,x)=>s+Number(x.amount),0)
let debt=totalCost-paid
let status="ØªØ³ÙˆÛŒÙ‡",cls="status-zero"
if(debt>0){status="Ø¨Ø¯Ù‡Ú©Ø§Ø±";cls="status-red"}
if(debt<0){status="Ø·Ù„Ø¨Ú©Ø§Ø±";cls="status-green"}
tbody.innerHTML+=`
<tr>
<td>${p.name}</td>
<td>${Number(paid).toLocaleString()}</td>
<td class="${cls}">${status}</td>
<td><button onclick="deletePlayer(${i})">Ø­Ø°Ù</button></td>
</tr>`
document.getElementById("payPlayer").innerHTML+=
`<option value="${p.name}">${p.name}</option>`
})
}

function submitPayment(){
let player=document.getElementById("payPlayer").value
let amount=document.getElementById("payAmount").value.replace(/,/g,'')
let date=document.getElementById("payDate").value
if(!player||!amount||!date)return
payments.push({player,amount,date})
document.getElementById("payAmount").value=""
document.getElementById("payDate").value=""
saveAll()
renderPlayers()
}

document.getElementById("payAmount").addEventListener("input",function(){
let val=this.value.replace(/,/g,'')
if(!val)return
this.value=Number(val).toLocaleString()
})

function init(){
if(reservations.length>0){
reservePicker.setDate(reservations)
document.getElementById("sessionCount").innerText=reservations.length
}
renderPlayers()
updateClock()
}
init()
</script>

</body>
</html>
